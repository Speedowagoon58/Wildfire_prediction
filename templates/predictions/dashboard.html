{% extends "base.html" %} {% load static %} {% block title %}Wildfire Risk
Dashboard{% endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  #map {
    height: 400px;
    width: 100%;
    margin-bottom: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 1;
    cursor: grab;
  }
  #map:active {
    cursor: grabbing;
  }
  .risk-legend {
    background: white;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }
  .risk-legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }
  .map-container {
    position: relative;
    margin-bottom: 2rem;
  }
  .leaflet-control-zoom {
    border: none !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  }
  .leaflet-control-zoom a {
    background-color: white !important;
    color: #333 !important;
    border: none !important;
  }
  .leaflet-control-zoom a:hover {
    background-color: #f8f9fa !important;
  }
  .leaflet-interactive {
    cursor: pointer !important;
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Wildfire Risk Dashboard</h1>

  {% if error_message %}
  <div class="alert alert-danger" role="alert">{{ error_message }}</div>
  {% endif %}

  <!-- Interactive Map -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Regional Risk Map</h5>
      <div class="map-container">
        <div id="map"></div>
        <div class="risk-legend">
          <h6>Risk Levels</h6>
          <div><i style="background: #dc3545"></i> High Risk</div>
          <div><i style="background: #ffc107"></i> Medium Risk</div>
          <div><i style="background: #198754"></i> Low Risk</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Predictions Grid -->
  <div class="row">
    {% for prediction in predictions %}
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">
            {{ prediction.region }} {% if prediction.major_forests %}
            <small class="text-muted d-block"
              >{{ prediction.major_forests|join:", " }}</small
            >
            {% endif %}
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6 class="card-subtitle mb-2">
              Risk Level: {% if prediction.risk_level == 'high' %}
              <span class="badge bg-danger">High Risk</span>
              {% elif prediction.risk_level == 'medium' %}
              <span class="badge bg-warning">Medium Risk</span>
              {% else %}
              <span class="badge bg-success">Low Risk</span>
              {% endif %}
            </h6>
          </div>
          <p class="card-text">{{ prediction.explanation }}</p>
        </div>
        <div class="card-footer text-muted">
          Last updated: {{ prediction.timestamp }}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="alert alert-info" role="alert">
        No predictions available at this time.
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %} {% block extra_js %}
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Initialize the map with explicit dragging enabled
      var map = L.map('map', {
          center: [0, 0],
          zoom: 2,
          dragging: true,
          tap: true,
          tapTolerance: 15,
          dragging: true,
          touchZoom: true,
          doubleClickZoom: true,
          keyboard: true
      });

      // Add the tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // Define risk level colors
      const riskColors = {
          'High Risk': '#dc3545',
          'Medium Risk': '#ffc107',
          'Low Risk': '#198754'
      };

      // Create a feature group for all markers
      var markers = L.featureGroup();

      // Add regions to the map
      {% for prediction in predictions %}
          var region = L.circle([{{ prediction.region.latitude }}, {{ prediction.region.longitude }}], {
              color: riskColors['{{ prediction.risk_level }}'],
              fillColor: riskColors['{{ prediction.risk_level }}'],
              fillOpacity: 0.5,
              radius: 50000,
              weight: 2,
              interactive: true,
              bubblingMouseEvents: true
          });

          // Add to feature group instead of directly to map
          markers.addLayer(region);

          region.bindPopup(`
              <strong>{{ prediction.region }}</strong><br>
              {% if prediction.major_forests %}
              <small class="text-muted">{{ prediction.major_forests|join:", " }}</small><br>
              {% endif %}
              Risk Level: {{ prediction.risk_level }}<br>
              {{ prediction.explanation }}
          `);
      {% endfor %}

      // Add markers to the map
      map.addLayer(markers);

      // Fit map bounds to show all regions
      if (markers.getLayers().length > 0) {
          map.fitBounds(markers.getBounds(), {
              padding: [50, 50]
          });
      }

      // Force a map refresh
      setTimeout(function() {
          map.invalidateSize();
      }, 100);

      // Ensure dragging is enabled
      map.dragging.enable();
  });
</script>
{% endblock %}
